<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­•æœŸé«”é‡é›²ç«¯è¿½è¹¤å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-50 min-h-screen p-4 font-sans">

    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-lg overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-pink-600 mb-2">ğŸ¤° å­•æœŸé«”é‡å°ç®¡å®¶</h1>
        
        <div class="bg-pink-100 rounded-xl p-4 mb-6">
            <p class="text-gray-700">ä»Šå¤©æ˜¯ï¼š<span id="currentDate" class="font-bold"></span></p>
            <p class="text-gray-700">ç›®å‰é€±æ•¸ï¼š<span id="currentWeek" class="text-pink-600 font-bold text-xl">--</span></p>
        </div>

        <div class="space-y-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">è¼¸å…¥ä»Šæ—¥é«”é‡ (kg)</label>
                <input type="number" id="weightInput" step="0.1" class="w-full mt-1 p-3 border border-pink-200 rounded-xl focus:ring-pink-500 outline-none">
            </div>
            <button onclick="handleSave()" id="saveBtn" class="w-full bg-pink-500 text-white py-3 rounded-xl font-bold hover:bg-pink-600 transition">å„²å­˜è‡³é›²ç«¯</button>
        </div>

        <div id="resultCard" class="hidden rounded-xl p-4 mb-6 text-center border-2">
            <p id="resultText" class="text-lg font-bold"></p>
            <p id="suggestionText" class="text-sm mt-1"></p>
        </div>

        <div class="mt-4">
            <canvas id="weightChart"></canvas>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwAp65Jjx4XCkV6pG1augL35H9rFuI-2vFewT3hIUMxniqYkovP8bu-x7bJQYvPcZUWpA/exec';
        const PRE_WEIGHT = 52.3;
        const DUE_DATE = new Date('2026-04-15');
        
        let weightChart;

        // åˆå§‹åŒ–ï¼šè¨ˆç®—é€±æ•¸ä¸¦è®€å–è³‡æ–™
        window.onload = () => {
            const today = new Date();
            document.getElementById('currentDate').innerText = today.toLocaleDateString();
            calculateWeeks();
            fetchHistory(); // å¾ Google Sheets æŠ“è³‡æ–™
        };

        function calculateWeeks() {
            const totalDays = 280;
            const diffTime = DUE_DATE - new Date();
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const currentDays = totalDays - daysLeft;
            const weeks = Math.floor(currentDays / 7);
            const days = currentDays % 7;
            document.getElementById('currentWeek').innerText = `${weeks} é€± + ${days} å¤©`;
            return weeks;
        }

        // è®€å– Google Sheets è³‡æ–™
        async function fetchHistory() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json(); 
                // data æ ¼å¼é æœŸç‚º: [[æ—¥æœŸ, é€±æ•¸, é«”é‡, ç‹€æ…‹], ...]
                updateChart(data);
            } catch (e) {
                console.error('è®€å–å¤±æ•—', e);
                updateChart([]); // å¤±æ•—æ™‚è‡³å°‘é¡¯ç¤ºåˆå§‹é«”é‡
            }
        }

        // å„²å­˜é‚è¼¯
        async function handleSave() {
            const weight = parseFloat(document.getElementById('weightInput').value);
            if (!weight) return alert('è«‹è¼¸å…¥é«”é‡');
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = 'å„²å­˜ä¸­...';

            const weekStr = document.getElementById('currentWeek').innerText;
            const statusInfo = getWeightStatus(weight);
            
            // é¡¯ç¤ºæœ¬åœ°åˆ¤æ–·çµæœ
            showResult(statusInfo);

            // POST åˆ° Google Sheets
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        weight: weight,
                        week: weekStr,
                        status: statusInfo.text
                    })
                });
                alert('é›²ç«¯åŒæ­¥æˆåŠŸï¼');
                fetchHistory(); // é‡æ–°æŠ“å–è³‡æ–™æ›´æ–°åœ–è¡¨
            } catch (e) {
                alert('åŒæ­¥å¤±æ•—ï¼Œä½†å·²ç‚ºæ‚¨é¡¯ç¤ºåˆ¤å®šçµæœ');
            } finally {
                btn.disabled = false;
                btn.innerText = 'å„²å­˜è‡³é›²ç«¯';
            }
        }

        function getWeightStatus(weight) {
            const week = calculateWeeks();
            let minG = 1, maxG = 2;
            if (week >= 13) {
                minG = 1 + (week - 12) * 0.4;
                maxG = 2 + (week - 12) * 0.5;
            }
            const minW = (PRE_WEIGHT + minG).toFixed(1);
            const maxW = (PRE_WEIGHT + maxG).toFixed(1);

            if (weight > maxW) return { color: 'red', text: 'è¶…æ¨™', range: `${minW}~${maxW}` };
            if (weight < minW) return { color: 'yellow', text: 'åè¼•', range: `${minW}~${maxW}` };
            return { color: 'green', text: 'éå¸¸åˆç†', range: `${minW}~${maxW}` };
        }

        function showResult(info) {
            const card = document.getElementById('resultCard');
            const resT = document.getElementById('resultText');
            card.classList.remove('hidden');
            
            if (info.color === 'red') {
                card.className = 'rounded-xl p-4 mb-6 text-center border-2 border-red-500 bg-red-50';
                resT.className = 'text-red-600 font-bold text-xl';
                resT.innerText = 'âŒ ' + info.text;
            } else if (info.color === 'green') {
                card.className = 'rounded-xl p-4 mb-6 text-center border-2 border-green-500 bg-green-50';
                resT.className = 'text-green-600 font-bold text-xl';
                resT.innerText = 'âœ… ' + info.text;
            } else {
                card.className = 'rounded-xl p-4 mb-6 text-center border-2 border-yellow-500 bg-yellow-50';
                resT.className = 'text-yellow-600 font-bold text-xl';
                resT.innerText = 'âš–ï¸ ' + info.text;
            }
            document.getElementById('suggestionText').innerText = `å»ºè­°ç¯„åœï¼š${info.range} kg`;
        }

        function updateChart(historyData) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            // æ•´ç†æ¨™ç±¤èˆ‡æ•¸å€¼ (åŠ å…¥æ‡·å­•å‰ä½œç‚ºèµ·é»)
            let labels = ['æ‡·å­•å‰'];
            let weights = [PRE_WEIGHT];
            
            historyData.forEach(row => {
                // row[0] æ˜¯æ—¥æœŸ, row[2] æ˜¯é«”é‡
                labels.push(new Date(row[0]).toLocaleDateString());
                weights.push(row[2]);
            });

            if (weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é«”é‡è¶¨å‹¢ (kg)',
                        data: weights,
                        borderColor: '#db2777',
                        backgroundColor: 'rgba(219, 39, 119, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });
        }
    </script>
</body>
</html>